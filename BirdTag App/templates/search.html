{% extends "base.html" %}

{% block title %}Search & API | BirdTag{% endblock %}

{% block page_title %}Search & Query Interface{% endblock %}
{% block page_description %}Search your bird media collection and test API endpoints{% endblock %}

{% block content %}
<style>
  .search-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
  }

  .search-section {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    border: 1px solid #e1e8ff;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .search-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    transition: left 0.3s ease;
  }

  .search-section:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
  }

  .search-section:hover::before {
    left: 0;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .section-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: white;
  }

  .section-title {
    font-size: 1.3rem;
    color: #333;
    font-weight: 600;
    margin: 0;
  }

  .section-description {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 25px;
    line-height: 1.5;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    font-weight: 500;
    color: #555;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e1e8ff;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8f9ff;
    font-family: inherit;
  }

  .form-textarea {
    resize: vertical;
    min-height: 80px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #4facfe;
    background: white;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
  }

  .form-input::placeholder,
  .form-textarea::placeholder {
    color: #999;
    font-style: italic;
  }

  .search-btn {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
    width: 100%;
    position: relative;
    overflow: hidden;
  }

  .search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
  }

  .search-btn:active {
    transform: translateY(0);
  }

  .search-btn.loading {
    opacity: 0.8;
    cursor: not-allowed;
  }

  .delete-btn {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
  }

  .delete-btn:hover {
    box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 20px;
    max-width: 80vw;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }

  .modal-overlay.show .modal-content {
    transform: scale(1);
  }

  .modal-header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin: 0;
  }

  .modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    transition: background 0.2s ease;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .modal-body {
    padding: 30px;
    max-height: 60vh;
    overflow-y: auto;
  }

  .result-container {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    background: #f8f9ff;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e1e8ff;
    white-space: pre-wrap;
    word-break: break-word;
    font-size: 0.9rem;
    line-height: 1.5;
    color: #333;
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .result-card {
    background: #f8f9ff;
    border-radius: 15px;
    padding: 15px;
    border: 1px solid #e1e8ff;
    transition: all 0.3s ease;
    text-align: center;
  }

  .result-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    background: white;
  }

  .result-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 10px;
    background: #e1e8ff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    font-size: 2rem;
  }

  .result-filename {
    font-size: 0.85rem;
    color: #333;
    font-weight: 500;
    margin-bottom: 5px;
    word-break: break-word;
  }

  .result-species {
    background: #e8f5e8;
    color: #2d5a2d;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.75rem;
    display: inline-block;
  }

  /* Loading Spinner */
  .loading-spinner {
    display: none;
    text-align: center;
    padding: 40px;
    color: #666;
  }

  .loading-spinner.show {
    display: block;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e1e8ff;
    border-top: 4px solid #4facfe;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .spinner-text {
    font-size: 1rem;
    color: #666;
  }

  /* File Upload Styling */
  .file-upload-area {
    border: 2px dashed #e1e8ff;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    background: #f8f9ff;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .file-upload-area:hover {
    border-color: #4facfe;
    background: #f0f4ff;
  }

  .file-upload-area.dragover {
    border-color: #4facfe;
    background: #e8f2ff;
    transform: scale(1.02);
  }

  .file-upload-icon {
    font-size: 2.5rem;
    color: #4facfe;
    margin-bottom: 10px;
  }

  .file-upload-text {
    color: #666;
    font-size: 1rem;
    margin-bottom: 5px;
  }

  .file-upload-subtext {
    color: #999;
    font-size: 0.85rem;
  }

  .file-upload-input {
    display: none;
  }

  .file-selected {
    background: #e8f5e8;
    color: #2d5a2d;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
    font-size: 0.9rem;
  }

  /* Success/Error States */
  .success-message {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
  }

  .error-message {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
  }

  @media (max-width: 768px) {
    .search-container {
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .search-section {
      padding: 20px;
    }

    .modal-content {
      max-width: 95vw;
      max-height: 90vh;
    }

    .modal-body {
      padding: 20px;
    }

    .results-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="search-container">
  <!-- Search by Tags and Count -->
  <div class="search-section">
    <div class="section-header">
      <div class="section-icon">üè∑Ô∏è</div>
      <div>
        <h2 class="section-title">Search by Tags & Count</h2>
      </div>
    </div>
    <p class="section-description">Find files containing specific bird species with minimum counts (e.g., at least 3
      crows and 2 pigeons)</p>

    <form id="form-tags-count">
      <div class="form-group">
        <label class="form-label">JSON Query</label>
        <textarea id="tags-count-input" class="form-textarea" rows="3"
          placeholder='{"crow": 3, "pigeon": 2}'></textarea>
      </div>
      <button type="submit" class="search-btn">
        üîç Search by Tags & Count
      </button>
    </form>
  </div>

  <!-- Search by Tags (no count) -->
  <div class="search-section">
    <div class="section-header">
      <div class="section-icon">üê¶</div>
      <div>
        <h2 class="section-title">Search by Species</h2>
      </div>
    </div>
    <p class="section-description">Find all files containing at least one instance of a specific bird species</p>

    <form id="form-tags-any">
      <div class="form-group">
        <label class="form-label">Species Array</label>
        <input id="tags-any-input" class="form-input" placeholder='["crow"]' />
      </div>
      <button type="submit" class="search-btn">
        üîç Search by Species
      </button>
    </form>
  </div>

  <!-- Get Full Image from Thumbnail -->
  <div class="search-section">
    <div class="section-header">
      <div class="section-icon">üñºÔ∏è</div>
      <div>
        <h2 class="section-title">Get Full Image</h2>
      </div>
    </div>
    <p class="section-description">Retrieve the full-resolution image URL from a thumbnail URL</p>

    <form id="form-thumb">
      <div class="form-group">
        <label class="form-label">Thumbnail S3 URL</label>
        <input id="thumb-url" class="form-input"
          placeholder="https://bucket.s3.region.amazonaws.com/thumbnails/image-thumb.jpg" />
      </div>
      <button type="submit" class="search-btn">
        üì∑ Get Full Image
      </button>
    </form>
  </div>

  <!-- Query by Uploaded File -->
  <div class="search-section">
    <div class="section-header">
      <div class="section-icon">üì§</div>
      <div>
        <h2 class="section-title">Query by File Upload</h2>
      </div>
    </div>
    <p class="section-description">Upload a file to find similar files with the same detected bird species</p>

    <form id="form-file-query">
      <div class="form-group">
        <label class="form-label">Upload File</label>
        <div class="file-upload-area" onclick="document.getElementById('file-upload').click()">
          <div class="file-upload-icon">üìÅ</div>
          <div class="file-upload-text">Click to select or drag & drop</div>
          <div class="file-upload-subtext">Images, videos, and audio files supported</div>
          <input type="file" id="file-upload" class="file-upload-input" accept="image/*,video/*,audio/*" required />
        </div>
        <div id="file-selected" class="file-selected" style="display: none;"></div>
      </div>
      <button type="submit" class="search-btn">
        üîç Query by File
      </button>
    </form>
  </div>

  <!-- Bulk Tag Add/Remove -->
  <div class="search-section">
    <div class="section-header">
      <div class="section-icon">üè∑Ô∏è</div>
      <div>
        <h2 class="section-title">Bulk Tag Management</h2>
      </div>
    </div>
    <p class="section-description">Add or remove tags from multiple files simultaneously (operation: 1=add, 0=remove)
    </p>

    <form id="form-tag-update">
      <div class="form-group">
        <label class="form-label">Bulk Update Payload</label>
        <textarea id="payload-input" class="form-textarea" rows="5"
          placeholder='{"url": ["https://..."], "operation": 1, "tags": ["crow,1", "pigeon,2"]}'></textarea>
      </div>
      <button type="submit" class="search-btn">
        üè∑Ô∏è Update Tags
      </button>
    </form>
  </div>

  <!-- Delete Files -->
  <div class="search-section">
    <div class="section-header">
      <div class="section-icon">üóëÔ∏è</div>
      <div>
        <h2 class="section-title">Delete Files</h2>
      </div>
    </div>
    <p class="section-description">Permanently delete files and their metadata from the system</p>

    <form id="form-delete">
      <div class="form-group">
        <label class="form-label">File URLs to Delete</label>
        <textarea id="urls-delete" class="form-textarea" rows="3"
          placeholder='["https://bucket.s3.amazonaws.com/file1.jpg", "https://bucket.s3.amazonaws.com/file2.jpg"]'></textarea>
      </div>
      <button type="submit" class="search-btn delete-btn">
        üóëÔ∏è Delete Files
      </button>
    </form>
  </div>
</div>

<!-- Results Modal -->
<div id="results-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title" class="modal-title">Search Results</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
        <div class="spinner-text">Processing your request...</div>
      </div>
      <div id="modal-results"></div>
    </div>
  </div>
</div>

<script>
  // Modal functions
  function showModal(title, content, isLoading = false) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('loading-spinner').classList.toggle('show', isLoading);
    document.getElementById('modal-results').style.display = isLoading ? 'none' : 'block';

    if (!isLoading) {
      document.getElementById('modal-results').innerHTML = content;
    }

    document.getElementById('results-modal').classList.add('show');
  }

  function closeModal() {
    document.getElementById('results-modal').classList.remove('show');
  }

  function updateModalContent(content) {
    document.getElementById('loading-spinner').classList.remove('show');
    document.getElementById('modal-results').style.display = 'block';
    document.getElementById('modal-results').innerHTML = content;
  }

  function formatJSON(data) {
    return `<div class="result-container">${JSON.stringify(data, null, 2)}</div>`;
  }

  function formatImageResults(data) {
    if (data.links && Array.isArray(data.links) && data.links.length > 0) {
      let html = '<div class="results-grid">';
      data.links.forEach(link => {
        const filename = link.split('/').pop();
        html += `
                    <div class="result-card">
                        <img src="${link}" class="result-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" loading="lazy" />
                        <div class="result-image" style="display: none;">üñºÔ∏è</div>
                        <div class="result-filename">${filename}</div>
                        <a href="${link}" target="_blank" class="result-species">View Full</a>
                    </div>
                `;
      });
      html += '</div>';
      return html;
    }
    return formatJSON(data);
  }

  async function postJSON(url, data, title = 'Search Results') {
    showModal(title, '', true);

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const result = await res.json();

      let content;
      if (url.includes('search') && result.links) {
        content = formatImageResults(result);
      } else {
        content = formatJSON(result);
      }

      updateModalContent(content);
    } catch (error) {
      updateModalContent(`<div class="error-message">Error: ${error.message}</div>`);
    }
  }

  // File upload handling
  const fileUpload = document.getElementById('file-upload');
  const fileSelected = document.getElementById('file-selected');
  const fileUploadArea = document.querySelector('.file-upload-area');

  fileUpload.addEventListener('change', function (e) {
    if (e.target.files[0]) {
      fileSelected.textContent = `Selected: ${e.target.files[0].name}`;
      fileSelected.style.display = 'block';
    }
  });

  // Drag and drop for file upload
  fileUploadArea.addEventListener('dragover', function (e) {
    e.preventDefault();
    fileUploadArea.classList.add('dragover');
  });

  fileUploadArea.addEventListener('dragleave', function (e) {
    e.preventDefault();
    fileUploadArea.classList.remove('dragover');
  });

  fileUploadArea.addEventListener('drop', function (e) {
    e.preventDefault();
    fileUploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileUpload.files = files;
      fileSelected.textContent = `Selected: ${files[0].name}`;
      fileSelected.style.display = 'block';
    }
  });

  // Close modal when clicking outside
  document.getElementById('results-modal').addEventListener('click', function (e) {
    if (e.target === this) {
      closeModal();
    }
  });

  // Original script functionality (keeping your working logic)
  // 1. Search by Tags & Count
  document.getElementById("form-tags-count").onsubmit = e => {
    e.preventDefault();
    const val = document.getElementById("tags-count-input").value;
    postJSON("/tags-counts-search", JSON.parse(val), "Search by Tags & Count");
  };

  // 2. Search by Tags (no count)  
  document.getElementById("form-tags-any").onsubmit = e => {
    e.preventDefault();
    const val = document.getElementById("tags-any-input").value;
    const species = JSON.parse(val)[0]; // Get first species from array
    postJSON("/species-search", { [species]: 1 }, "Search by Species");
  };

  // 3. Get Full Image from Thumbnail
  document.getElementById("form-thumb").onsubmit = async e => {
    e.preventDefault();
    showModal("Get Full Image", "", true);

    try {
      const url = document.getElementById("thumb-url").value;
      const res = await fetch(`/thumbnail-search?url=${encodeURIComponent(url)}`);
      const data = await res.json();
      updateModalContent(formatJSON(data));
    } catch (error) {
      updateModalContent(`<div class="error-message">Error: ${error.message}</div>`);
    }
  };

  // 4. Query by Uploaded File
  document.getElementById("form-file-query").onsubmit = async e => {
    e.preventDefault();
    showModal("Query by File", "", true);

    try {
      const form = new FormData();
      form.append("file", document.getElementById("file-upload").files[0]);
      const res = await fetch("/file-search", { method: "POST", body: form });
      const data = await res.json();

      let content;
      if (data.links) {
        content = formatImageResults(data);
      } else {
        content = formatJSON(data);
      }
      updateModalContent(content);
    } catch (error) {
      updateModalContent(`<div class="error-message">Error: ${error.message}</div>`);
    }
  };

  // 5. Add/Remove Tags (Bulk)
  document.getElementById("form-tag-update").onsubmit = e => {
    e.preventDefault();
    const val = document.getElementById("payload-input").value;
    postJSON("/tags-update", JSON.parse(val), "Bulk Tag Update");
  };

  // 6. Delete Files
  document.getElementById("form-delete").onsubmit = e => {
    e.preventDefault();
    const val = document.getElementById("urls-delete").value;
    postJSON("/file-deletion", { "urls": JSON.parse(val) }, "Delete Files");
  };
</script>
{% endblock %}